import{T as b,b as D,c as f,D as y,d as S}from"./lib-es-BdVxwK9Z-B9dpt8vi.js";import{l}from"./semver-DQp6anwM-IwHLRqB3.js";import{T as x,i as g,h as I,l as h}from"./lib-es-DZEyST3--mHrXDXPA.js";import{$ as B}from"./injective-utils-C9MYzl-J.js";import"./icons-Dj0zHVqu.js";const N=[{vendorId:h}];async function w(){return await navigator.usb.requestDevice({filters:N})}async function d(){return(await navigator.usb.getDevices()).filter(r=>r.vendorId===h)}async function T(){const r=await d();return r.length>0?r[0]:w()}const E=()=>Promise.resolve(!!navigator&&!!navigator.usb&&typeof navigator.usb.getDevices=="function"),M=1,m=3;var _=class u extends x{device;deviceModel;channel=Math.floor(Math.random()*65535);packetSize=64;interfaceNumber;constructor(e,t){super(),this.device=e,this.interfaceNumber=t,this.deviceModel=g(e.productId)}static isSupported=E;static list=d;static listen=e=>{let t=!1;T().then(n=>{if(!t){const a=g(n.productId);e.next({type:"add",descriptor:n,deviceModel:a}),e.complete()}},n=>{window.DOMException&&n instanceof window.DOMException&&n.code===18?e.error(new b(n.message)):e.error(new D(n.message))});function s(){t=!0}return{unsubscribe:s}};static async request(){const e=await w();return u.open(e)}static async openConnected(){const e=await d();return e.length===0?null:u.open(e[0])}static async open(e){await e.open(),e.configuration===null&&await e.selectConfiguration(M),await p(e);const t=e.configurations[0].interfaces.find(({alternates:i})=>i.some(c=>c.interfaceClass===255));if(!t)throw new f("No WebUSB interface found for your Ledger device. Please upgrade firmware or contact techsupport.");const s=t.interfaceNumber;try{await e.claimInterface(s)}catch(i){throw await e.close(),new f(i.message)}const n=new u(e,s),a=i=>{e===i.device&&(navigator.usb.removeEventListener("disconnect",a),n._emitDisconnect(new S))};return navigator.usb.addEventListener("disconnect",a),n}_disconnectEmitted=!1;_emitDisconnect=e=>{this._disconnectEmitted||(this._disconnectEmitted=!0,this.emit("disconnect",e))};async close(){await this.exchangeBusyPromise,await this.device.releaseInterface(this.interfaceNumber),await p(this.device),await this.device.close()}async exchange(e){return await this.exchangeAtomicImpl(async()=>{const{channel:t,packetSize:s}=this;l("apdu","=> "+e.toString("hex"));const n=I(t,s),a=n.makeBlocks(e);for(let o=0;o<a.length;o++)await this.device.transferOut(m,a[o]);let i,c;for(;!(i=n.getReducedResult(c));){const o=await this.device.transferIn(m,s),v=B.Buffer.from(o.data.buffer);c=n.reduceResponse(c,v)}return l("apdu","<= "+i.toString("hex")),i}).catch(t=>{throw t&&t.message&&t.message.includes("disconnected")?(this._emitDisconnect(t),new y(t.message)):t})}setScrambleKey(){}};async function p(r){try{await r.reset()}catch{}}export{_ as default};
